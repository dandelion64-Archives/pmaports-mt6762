# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20230104
_commit="24db62dbe710b4ecace9b43a44239aa97f7efa01"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/development/core/lomiri"
license="GPL-3.0 LGPL-2.1"
# FIXME add maliit-keyboard
depends="
	ayatana-indicator-keyboard
	ayatana-indicator-session
	gsettings-desktop-schemas
	lomiri-schemas
	lomiri-settings-components
	lomiri-system-compositor
	openrc-settingsd
	qt5-qtbase-sqlite
	qt5-qtgraphicaleffects
	suru-icon-theme
	"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock lomiri-indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev elogind-dev qtmir-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/development/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-Add-missing-includes.patch
	0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0004-Link-against-libintl.patch
	0005-No-systemd.patch
	0006-fixups.patch
	"
subpackages="$pkgname-lang indicators-client:indicators_client"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Tests fail

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel.1/
}

indicators_client() {
	pkgdesc="Indicators client test application"
	amove usr/bin/indicators-client
	amove usr/share/applications/indicators-client.desktop
}

sha512sums="
94c74363f4073893b29621799bc2f9c72b8b032f27568c4115ac562453f6cddfe56fe70a674a25cf86728f87f6af1b1ae1b723045ef7add5769f26406ba95a16  lomiri-24db62dbe710b4ecace9b43a44239aa97f7efa01.tar.gz
628382be3a6679511abf2d3517c8b65ff212a2639fcaf5b695b5e030bc7ba6f78eb3c30754b78079d63a8280d43da09ddebad69bc941909c13ac28b7b88ea858  0001-NoDpkgParse.patch
dca700689aa4b8abeb8280bea160b42c63ff86aefce73257b3ca3847d05217c92707fe85863292e77ddaf8d9bb9056c8959c3f2ada6802d633860109260c64ce  0002-Add-missing-includes.patch
e795172037595cd70555550263a5128bb24b93e2be0bd9c3aa098dddc85ff724c26f8407d30ca1eaa435f2797b5e1a402848fd1745cbc722f3c83247190cd999  0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
b4d4e422de0297a9eb04550d54afa7a5bc945460d910c6bc212343d3ed792f555627593f26338c4db558bfa9018f683cee226581c4709f257884c5b70454e668  0004-Link-against-libintl.patch
9250a3f652299300950dcaa16350e7dc40cba673a13da746e9ccae44b7a8bd9043a82bd1db78d656c3a7915c07bcff46a3d22bacf1d83e1fa9ff3c8ddfeb6d47  0005-No-systemd.patch
0dff3ae2c79a00f49b248f58ebe89293187486d66d5e5e4ec523525d91b6d267b217811456dde9c23baae5a02cda2d57e9fc3fc3df1f1a61ee4291fb5c7d40d0  0006-fixups.patch
"

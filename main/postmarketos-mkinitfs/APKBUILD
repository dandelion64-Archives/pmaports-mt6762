# Maintainer: Oliver Smith <ollieparanoid@postmarketos.org>
# Co-Maintainer: Clayton Craft <clayton@craftyguy.net>
pkgname=postmarketos-mkinitfs
pkgver=1.5.1
pkgrel=3
pkgdesc="Tool to generate initramfs images for postmarketOS"
url="https://postmarketos.org"
depends="
	boot-deploy
	busybox-extras
	btrfs-progs
	bzip2
	cryptsetup
	device-mapper
	e2fsprogs
	e2fsprogs-extra
	f2fs-tools
	lz4
	multipath-tools
	parted
	postmarketos-fde-unlocker
	unudhcpd
	xz
	"
makedepends="go"
replaces="mkinitfs"
triggers="$pkgname.trigger=/etc/postmarketos-mkinitfs/hooks:/usr/share/kernel/*:/usr/share/postmarketos-mkinitfs-triggers"
source="
	https://gitlab.com/postmarketOS/postmarketos-mkinitfs/-/archive/$pkgver/postmarketos-mkinitfs-$pkgver.tar.gz
	00-default.modules
	init.sh
	init_functions.sh
	"
install="$pkgname.post-upgrade"
arch="all"
license="GPL-2.0-or-later"
provider_priority=999  # higher priority than Alpine's mkinitfs
provides="initramfs-generator"

export GOPATH="$srcdir"
export CGO_ENABLED=0

build() {
	unset LDFLAGS  # passed to Go as linker flags, which are invalid
	make
}

package() {
	install -Dm644 "$srcdir/init_functions.sh" \
		"$pkgdir/usr/share/postmarketos-mkinitfs/init_functions.sh"

	install -Dm755 "$srcdir/init.sh" \
		"$pkgdir/usr/share/postmarketos-mkinitfs/init.sh"

	install -Dm644 "$srcdir/00-default.modules" \
		"$pkgdir/etc/postmarketos-mkinitfs/modules/00-default.modules"

	mkdir -p "$pkgdir/etc/postmarketos-mkinitfs/hooks/"

	make PREFIX=/usr DESTDIR="$pkgdir" install
}

check() {
	go test ./...
}

sha512sums="
d28802b17d7912a58d23c02fbdddfdb6f74489e712d61a59472f7f000a4429786f69ba2fca59d321c55c277ff79edb6f47c939a9e973b31f694aeca0167354ff  postmarketos-mkinitfs-1.5.1.tar.gz
15f3cf0335e32684de7f1c02a0818ba2389f8af2db11b2a527ff0f09ef3cd7a406565be46770a559aeae27e3f6d80b40eb690d8db4b702df4f0a243c9b500506  00-default.modules
1d27b85d332a0a0977f9a81ba3a32400ca6398fe801f40ceae68aa5c6e9991579725e73ce312516ebf681be1510ad20e9607d132e9f0c01aed19cd2004b023b1  init.sh
56fe394412c4dba6d4cd70aa6d85bfd8f4f2feac99d19ab4b8705bafabc1017bff948986afbd61adc83f240c0901253ebe19e400fa5d49ed7473e612b6b0575f  init_functions.sh
"
